<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mambakkadans Steels & Cements</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

<style>
    :root {
        --primary-color: #0f172a; /* Deep Industrial Blue */
        --accent-color: #2563eb;  /* Bright Blue */
        --bg-color: #f1f5f9;
        --card-bg: #ffffff;
        --text-color: #334155;
    }

    body {
        font-family: 'Roboto', sans-serif;
        background: var(--bg-color);
        margin: 0;
        padding: 40px 20px;
        color: var(--text-color);
    }

    .container {
        background: var(--card-bg);
        padding: 50px;
        max-width: 1000px;
        margin: auto;
        border-radius: 12px;
        box-shadow: 0px 10px 30px rgba(0,0,0,0.08);
    }

    /* HEADER STYLES */
    .header {
        text-align: center;
        margin-bottom: 40px;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 20px;
    }

    h1 {
        font-family: 'Poppins', sans-serif;
        font-weight: 800;
        font-size: 42px; /* Large Font */
        color: var(--primary-color);
        margin: 0;
        letter-spacing: -1px;
        text-transform: uppercase;
    }

    .subtitle {
        font-family: 'Poppins', sans-serif;
        font-size: 16px;
        color: #64748b;
        letter-spacing: 2px;
        margin-top: 5px;
        text-transform: uppercase;
        font-weight: 600;
    }

    /* INPUT GRID */
    .input-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
        background: #f8fafc;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .input-group {
        display: flex;
        flex-direction: column;
    }

    label {
        font-size: 13px;
        font-weight: 600;
        color: #475569;
        margin-bottom: 6px;
        text-transform: uppercase;
    }

    input, select {
        padding: 12px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        font-size: 15px;
        outline: none;
        transition: border-color 0.2s;
    }

    input:focus, select:focus {
        border-color: var(--accent-color);
    }

    /* BUTTONS */
    .action-row {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
    }

    button {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.2s;
        font-family: 'Poppins', sans-serif;
    }

    .btn-add {
        background: var(--primary-color);
        color: white;
        flex: 1;
    }
    .btn-add:hover { background: #1e293b; }

    .btn-reset {
        background: #ef4444;
        color: white;
    }
    .btn-reset:hover { background: #dc2626; }

    .btn-pdf {
        background: var(--accent-color);
        color: white;
        width: 100%;
        margin-top: 20px;
        font-size: 18px;
        padding: 15px;
    }
    .btn-pdf:hover { background: #1d4ed8; }

    /* TABLE */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 15px;
    }

    th {
        background: var(--primary-color);
        color: white;
        padding: 14px;
        text-align: left;
        font-weight: 500;
        letter-spacing: 0.5px;
    }

    td {
        border-bottom: 1px solid #e2e8f0;
        padding: 12px 14px;
        color: #334155;
    }

    tr:last-child td { border-bottom: none; }
    tr:nth-child(even) { background-color: #f8fafc; }

    /* TOTALS SECTION */
    .totals-card {
        margin-top: 30px;
        background: #f1f5f9;
        padding: 20px;
        border-radius: 8px;
        text-align: right;
    }

    .totals-line {
        margin: 5px 0;
        font-size: 16px;
        color: #64748b;
    }

    .totals-final {
        margin-top: 10px;
        font-size: 24px;
        color: var(--primary-color);
        font-weight: 800;
        font-family: 'Poppins', sans-serif;
    }

</style>
</head>

<body>

<div class="container">

    <div class="header">
        <h1>Mambakkadans Steels & Cements</h1>
        <div class="subtitle">Professional Quotation System</div>
    </div>

    <div class="input-grid">
        <div class="input-group">
            <label>Customer Name</label>
            <input type="text" id="customer" placeholder="Enter name">
        </div>
        <div class="input-group">
            <label>Date</label>
            <input type="date" id="date">
        </div>
        <div class="input-group">
            <label>Universal Rate (₹/kg)</label>
            <input type="number" id="rate" value="74" oninput="recalcAll()">
        </div>
        <div class="input-group">
            <label>Freight / Coolie (₹)</label>
            <input type="number" id="freight" value="0" oninput="updateTotals()">
        </div>
    </div>

    <div class="input-grid" style="grid-template-columns: 2fr 1fr 1fr;">
        <div class="input-group">
            <label>Size</label>
            <select id="size"></select>
        </div>
        <div class="input-group">
            <label>Gauge</label>
            <select id="gauge">
                <option value="16" selected>16 Gauge</option>
                <option value="18">18 Gauge</option>
            </select>
        </div>
        <div class="input-group">
            <label>Quantity (Nos)</label>
            <input type="number" id="qty" min="1" placeholder="0">
        </div>
    </div>

    <div class="action-row">
        <button class="btn-add" onclick="addItem()">+ Add Item</button>
        <button class="btn-reset" onclick="resetBill()">Reset</button>
    </div>

    <table>
        <thead>
            <tr>
                <th width="30%">Size</th>
                <th>Gauge</th>
                <th>Qty</th>
                <th>Wt/No</th>
                <th>Total Wt</th>
                <th>Rate</th>
                <th style="text-align:right;">Amount</th>
            </tr>
        </thead>
        <tbody id="billBody"></tbody>
    </table>

    <div class="totals-card">
        <div class="totals-line" id="totalWeight">Total Weight: 0.00 kg</div>
        <div class="totals-line" id="freightDisplay">Freight: ₹0.00</div>
        <div class="totals-final" id="finalTotal">₹0.00</div>
    </div>

    <button class="btn-pdf" onclick="saveQuotation()">Download Official PDF Quote</button>

</div>

<script>
    // Set default date to today
    document.getElementById('date').valueAsDate = new Date();

    // ===== DATA =====
    const gpData = {
        "1/2 * 1/2": {16:3.8, 18:3.2},
        "3/4 * 3/4": {16:4.8, 18:4.0},
        "1 * 1": {16:6.2, 18:5.2},
        "1 1/4 * 1 1/4": {16:7.9, 18:null},
        "1 1/2 * 1 1/2": {16:9.8, 18:null},
        "2 * 2": {16:12.3, 18:null},
        "3 * 3": {16:19.0, 18:null},
        "4 * 4": {16:38.0, 18:null},
        "1 * 10": {16:4.4, 18:null},
        "1 1/2 * 10": {16:6.2, 18:null},
        "1 1/2 * 3/4": {16:7.6, 18:null},
        "2 * 1": {16:9.5, 18:8.5},
        "2 1/2 * 1 1/2": {16:13.0, 18:12.5},
        "3 * 1": {16:12.8, 18:11.0},
        "3 * 1 1/2": {16:15.3, 18:12.8},
        "4 * 1": {16:15.1, 18:null},
        "4 * 2": {16:19.0, 18:null}
    };

    // Populate Dropdown
    const sizeDropdown = document.getElementById("size");
    for (let size in gpData) {
        let option = document.createElement("option");
        option.value = size;
        option.text = size;
        sizeDropdown.add(option);
    }

    // State Variables
    let cartItems = []; 

    function addItem() {
        const size = document.getElementById("size").value;
        const gauge = document.getElementById("gauge").value;
        const qty = parseFloat(document.getElementById("qty").value);
        const rate = parseFloat(document.getElementById("rate").value);

        if (!qty || qty <= 0) { alert("Please enter a valid quantity"); return; }

        // Logic: Use correct weight, default to 16G if specific gauge not found for that size
        let weightPerNo = gpData[size][gauge];
        if (!weightPerNo) { 
            weightPerNo = gpData[size][16]; 
            alert(`Note: ${gauge}G not available for ${size}. Used 16G weight.`);
        }

        const totalWeight = weightPerNo * qty;
        const amount = totalWeight * rate;

        const newItem = {
            size: size,
            gauge: gauge,
            qty: qty,
            weightPerNo: weightPerNo,
            totalWeight: totalWeight,
            rate: rate,
            amount: amount
        };

        cartItems.push(newItem);
        renderTable();
        document.getElementById("qty").value = "";
        document.getElementById("qty").focus();
    }

    function renderTable() {
        const tbody = document.getElementById("billBody");
        tbody.innerHTML = "";
        
        cartItems.forEach((item, index) => {
            let row = `<tr>
                <td>${item.size}</td>
                <td>${item.gauge}G</td>
                <td>${item.qty}</td>
                <td>${item.weightPerNo}</td>
                <td>${item.totalWeight.toFixed(2)}</td>
                <td>${item.rate}</td>
                <td style="text-align:right;">${item.amount.toFixed(2)}</td>
            </tr>`;
            tbody.innerHTML += row;
        });

        updateTotals();
    }

    // New helper to recalc if rate changes mid-way
    function recalcAll() {
        const newRate = parseFloat(document.getElementById("rate").value) || 0;
        cartItems.forEach(item => {
            item.rate = newRate;
            item.amount = item.totalWeight * newRate;
        });
        renderTable();
    }

    function updateTotals() {
        let grandWeight = 0;
        let grandTotal = 0;

        cartItems.forEach(item => {
            grandWeight += item.totalWeight;
            grandTotal += item.amount;
        });

        const freight = parseFloat(document.getElementById("freight").value) || 0;

        document.getElementById("totalWeight").innerText = "Total Weight: " + grandWeight.toFixed(2) + " kg";
        document.getElementById("freightDisplay").innerText = "Freight: ₹" + freight.toFixed(2);
        document.getElementById("finalTotal").innerHTML = "Total: ₹" + (grandTotal + freight).toFixed(2);
    }

    function resetBill() {
        if(confirm("Are you sure you want to clear the bill?")){
            cartItems = [];
            renderTable();
            document.getElementById("freight").value = 0;
            updateTotals();
        }
    }

    // ===== FIXED PDF GENERATION =====
    async function saveQuotation() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const customer = document.getElementById("customer").value || "Cash Customer";
        const date = document.getElementById("date").value;
        const freight = parseFloat(document.getElementById("freight").value) || 0;
        
        // Calculate Totals for PDF
        let pdfWeight = 0;
        let pdfItemTotal = 0;
        const tableRows = cartItems.map(item => {
            pdfWeight += item.totalWeight;
            pdfItemTotal += item.amount;
            return [
                item.size,
                item.gauge + "G",
                item.qty,
                item.weightPerNo,
                item.totalWeight.toFixed(2),
                item.rate,
                item.amount.toFixed(2)
            ];
        });

        // Header
        doc.setFontSize(22);
        doc.setFont("helvetica", "bold");
        doc.text("MAMBAKKADANS STEELS & CEMENTS", 105, 20, null, null, "center");
        
        doc.setFontSize(12);
        doc.setFont("helvetica", "normal");
        doc.text("Quotation / Estimate", 105, 28, null, null, "center");

        // Customer Info
        doc.setFontSize(11);
        doc.text(`Customer: ${customer}`, 14, 40);
        doc.text(`Date: ${date}`, 160, 40);

        // Table
        doc.autoTable({
            startY: 45,
            head: [['Size', 'Gauge', 'Qty', 'Wt/No', 'Total Wt', 'Rate', 'Amount']],
            body: tableRows,
            theme: 'striped',
            headStyles: { fillColor: [15, 23, 42] }, // Matches Dark Blue UI
            foot: [
                ['', '', '', '', pdfWeight.toFixed(2) + ' kg', 'Subtotal:', pdfItemTotal.toFixed(2)],
                ['', '', '', '', '', 'Freight:', freight.toFixed(2)],
                ['', '', '', '', '', 'TOTAL:', (pdfItemTotal + freight).toFixed(2)]
            ],
            footStyles: { fillColor: [241, 245, 249], textColor: [0,0,0], fontStyle: 'bold' }
        });

        // Footer Note
        doc.setFontSize(10);
        doc.text("Thank you for your business!", 105, doc.lastAutoTable.finalY + 20, null, null, "center");

        // Save
        doc.save(`${customer}_Quotation.pdf`);
    }

</script>

</body>
</html>